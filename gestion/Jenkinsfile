// gestion/Jenkinsfile
// --- C√ìDIGO COMPLETAMENTE CORREGIDO (Sintaxis, L√≥gica Etapa 2, Permisos) ---

pipeline {
    agent any

    environment {
        // --- Variables Globales ---
        AWS_REGION                 = "us-east-1"
        ECS_CLUSTER_NAME           = "proyecto-cluster"
        ECS_SERVICE_NAME           = "proyecto-servicio" // El servicio que crearemos
        ECS_TASK_FAMILY            = "proyecto-gestion-task"
        // Tag √∫nico para la imagen
        IMAGE_TAG                  = "build-${env.BUILD_NUMBER}"
    }

    stages {

        // --- Etapa 1: Ejecutar Terraform (Crear el Cl√∫ster) ---
        stage('Automatizar Creaci√≥n de Infra (Terraform)') {
            when {
                expression { params.RUN_TERRAFORM }
            }
            steps {
                // Ruta corregida
                dir('gestion/infra_aws') { 
                    withAWS(credentials: 'aws-credentials-jenkins', region: env.AWS_REGION) {
                        // Usamos la credencial 'rds-db-password' para la contrase√±a de la BD
                        withCredentials([string(credentialsId: 'rds-db-password', variable: 'DB_PASS_SECRET')]) {
                            sh 'terraform init'
                            sh "terraform apply -auto-approve -var 'db_password=${DB_PASS_SECRET}'"
                        }
                    }
                }
            }
        }

       // --- Etapa 2: Crear el Servicio ECS (Solo la primera vez, idempotente) ---
stage('Crear Servicio ECS (Solo la primera vez)') {
    when {
        expression { params.CREATE_SERVICE }
    }
    steps {
        withAWS(credentials: 'aws-credentials-jenkins', region: env.AWS_REGION) {
            script {
                // Verificar si el servicio ya existe
                def serviceStatus = sh(
                    returnStdout: true,
                    script: """
                        aws ecs describe-services --cluster ${ECS_CLUSTER_NAME} \
                        --services ${ECS_SERVICE_NAME} \
                        --query 'services[0].status' --output text 2>/dev/null || echo "None"
                    """
                ).trim()

                if (serviceStatus != "ACTIVE" && serviceStatus != "DRAINING") {
                    echo "üü¢ El servicio '${ECS_SERVICE_NAME}' no existe. Cre√°ndolo ahora..."

                    def awsAccountId = sh(returnStdout: true, script: 'aws sts get-caller-identity --query Account --output text').trim()
                    def ecsTaskRoleArn = "arn:aws:iam::${awsAccountId}:role/proyecto-ecs-task-execution-role"
                    def subnets = sh(returnStdout: true, script: "aws ec2 describe-subnets --filters 'Name=tag:Name,Values=proyecto-public-*' --query 'Subnets[*].SubnetId' --output json").trim()
                    def sg = sh(returnStdout: true, script: "aws ec2 describe-security-groups --filters 'Name=group-name,Values=proyecto-ecs-sg' --query 'SecurityGroups[0].GroupId' --output text").trim()
                    def tg_arn = sh(returnStdout: true, script: "aws elbv2 describe-target-groups --names proyecto-alb-tg --query 'TargetGroups[0].TargetGroupArn' --output text").trim()

                    // Definici√≥n temporal para iniciar el servicio
                    def dummyTaskJson = """
                    {
                        "family": "${ECS_TASK_FAMILY}",
                        "executionRoleArn": "${ecsTaskRoleArn}",
                        "networkMode": "awsvpc",
                        "cpu": "256",
                        "memory": "512",
                        "requiresCompatibilities": ["FARGATE"],
                        "containerDefinitions": [
                            {
                                "name": "web",
                                "image": "nginx:alpine",
                                "essential": true,
                                "portMappings": [
                                    { "containerPort": 80, "protocol": "tcp" }
                                ]
                            }
                        ]
                    }
                    """
                    writeFile file: 'dummy-task.json', text: dummyTaskJson

                    def dummyTaskRevision = sh(returnStdout: true, script: """
                        aws ecs register-task-definition --cli-input-json file://dummy-task.json \
                        --query 'taskDefinition.taskDefinitionArn' --output text
                    """).trim()

                    sh """
                        aws ecs create-service --cluster ${ECS_CLUSTER_NAME} \
                        --service-name ${ECS_SERVICE_NAME} \
                        --task-definition ${dummyTaskRevision} \
                        --launch-type FARGATE \
                        --desired-count 1 \
                        --network-configuration "awsvpcConfiguration={subnets=${subnets},securityGroups=[${sg}],assignPublicIp=ENABLED}" \
                        --load-balancers "targetGroupArn=${tg_arn},containerName=web,containerPort=80"
                    """

                    echo "‚úÖ Servicio '${ECS_SERVICE_NAME}' creado correctamente."
                } else {
                    echo "‚ö†Ô∏è El servicio '${ECS_SERVICE_NAME}' ya existe, se omite la creaci√≥n."
                }
            }
        }
    }
}


        // --- Etapa 3: Build de la Aplicaci√≥n Laravel ---
        stage('Build Docker App (Laravel)') {
            steps {
                // Ruta corregida
                dir('gestion') { 
                    withAWS(credentials: 'aws-credentials-jenkins', region: env.AWS_REGION) {
                        script {
                            def awsAccountId = sh(returnStdout: true, script: 'aws sts get-caller-identity --query Account --output text').trim()
                            def ecrAppRepoUrl = "${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com/proyecto-gestion-app"

                            // Hacemos login en ECR
                            sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com"
                            
                            // Construimos la imagen de la app
                            sh "docker build -t ${ecrAppRepoUrl}:${IMAGE_TAG} -f Dockerfile ."
                            
                            // Subimos la imagen de la app
                            sh "docker push ${ecrAppRepoUrl}:${IMAGE_TAG}"
                        }
                    }
                }
            }
        }

        // --- Etapa 4: Build del Servidor Web (Nginx) ---
        stage('Build Docker Web (Nginx)') {
            steps {
                withAWS(credentials: 'aws-credentials-jenkins', region: env.AWS_REGION) {
                    script {
                        def awsAccountId = sh(returnStdout: true, script: 'aws sts get-caller-identity --query Account --output text').trim()
                        def ecrWebRepoUrl = "${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com/proyecto-gestion-web"
                        
                        // Creamos un Dockerfile temporal para Nginx
                        writeFile file: 'Dockerfile.nginx', text: """
                            FROM nginx:1.25-alpine
                            # Aseg√∫rate de que tu archivo se llama 'nginx.conf'
                            COPY gestion/docker/nginx.conf /etc/nginx/conf.d/default.conf
                        """
                        
                        sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com"
                        
                        // Construimos la imagen de Nginx
                        sh "docker build -t ${ecrWebRepoUrl}:${IMAGE_TAG} -f Dockerfile.nginx ."
                        
                        // Subimos la imagen de Nginx
                        sh "docker push ${ecrWebRepoUrl}:${IMAGE_TAG}"
                    }
                }
            }
        }
        
        // --- Etapa 5: Desplegar en ECS (Actualizar Servicio) ---
        stage('Deploy to ECS') {
            steps {
                // Ruta corregida
                dir('gestion') { 
                    withAWS(credentials: 'aws-credentials-jenkins', region: env.AWS_REGION) {
                        script { 
                            withCredentials([string(credentialsId: 'rds-db-password', variable: 'DB_PASS_SECRET')]) {
                        
                                // Obtenemos TODAS las variables din√°micas de AWS aqu√≠
                                def awsAccountId = sh(returnStdout: true, script: 'aws sts get-caller-identity --query Account --output text').trim()
                                def ecrAppRepoUrl = "${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com/proyecto-gestion-app"
                                def ecrWebRepoUrl = "${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com/proyecto-gestion-web"
                                def ecsTaskRoleArn = "arn:aws:iam::${awsAccountId}:role/proyecto-ecs-task-execution-role"
                                def albDnsName = sh(returnStdout: true, script: "aws elbv2 describe-load-balancers --names proyecto-alb --query 'LoadBalancers[0].DNSName' --output text").trim()
                                def dbEndpoint = sh(returnStdout: true, script: "aws rds describe-db-instances --db-instance-identifier-prefix proyecto-db --query 'DBInstances[0].Endpoint.Address' --output text").trim()

                                // 1. Rellenamos la plantilla JSON
                                def taskTemplate = readFile('task-definition-template.json')
                                def taskDef = taskTemplate
                                    .replace('${ECS_TASK_EXECUTION_ROLE_ARN}', ecsTaskRoleArn)
                                    .replace('${ECR_APP_REPO_URL}', ecrAppRepoUrl)
                                    .replace('${ECR_WEB_REPO_URL}', ecrWebRepoUrl)
                                    .replace('${IMAGE_TAG}', env.IMAGE_TAG)
                                    .replace('${ALB_DNS_NAME}', albDnsName)
                                    .replace('${DB_ENDPOINT}', dbEndpoint)
                                    .replace('${DB_PASSWORD}', DB_PASS_SECRET)

                                writeFile file: 'new-task-def.json', text: taskDef
                                
                                // 2. Registramos la nueva Task Definition
                                def taskRevision = sh(returnStdout: true, script: "aws ecs register-task-definition --cli-input-json file://new-task-def.json --query 'taskDefinition.taskDefinitionArn' --output text").trim()
                                
                                echo "Nueva Task Definition registrada: ${taskRevision}"

                                // 3. Actualizamos el servicio
                                sh "aws ecs update-service --cluster ${ECS_CLUSTER_NAME} --service ${ECS_SERVICE_NAME} --task-definition ${taskRevision} --force-new-deployment"
                                
                                echo "¬°Despliegue iniciado en ECS!"

                                // 4. Ejecutar migraciones
                                echo "Ejecutando migraciones..."
                                sh """
                                   aws ecs run-task --cluster ${ECS_CLUSTER_NAME} \
                                   --task-definition ${taskRevision} \
                                   --launch-type FARGATE \
                                   --network-configuration "awsvpcConfiguration={subnets=[${sh(returnStdout: true, script: "aws ec2 describe-subnets --filters 'Name=tag:Name,Values=proyecto-public-a' --query 'Subnets[0].SubnetId' --output text").trim()}],securityGroups=[${sh(returnStdout: true, script: "aws ec2 describe-security-groups --filters 'Name=group-name,Values=proyecto-ecs-sg' --query 'SecurityGroups[0].GroupId' --output text").trim()}]}" \
                                   --overrides '{"containerOverrides":[{"name":"app","command":["php","artisan","migrate","--force"]}]}'
                                """
                            }
                        } 
                    }
                }
            }
        }
    }
}